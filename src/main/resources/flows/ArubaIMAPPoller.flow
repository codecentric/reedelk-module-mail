{
  "id": "878b3f63-d441-4ac4-9ba9-7254f113ec7a",
  "title": "IMAP Listener",
  "description": "IMAP Listener Flow",
  "flow": [
    {
      "implementor": "com.reedelk.mail.component.IMAPMailListener",
      "description": "Aruba IMAP Mail Listener (IMAP)",
      "configuration": {"ref": "fe4636e8-0757-417b-a7e2-f7e40fd9b5d2"},
      "peek": true,
      "strategy": "POLLING",
      "pollInterval": 120000,
      "markDeleteOnSuccess": true,
      "flags": {
        "seen": "NO",
        "deleted": "YES"
      }
    },
    {
      "implementor": "com.reedelk.core.component.LoggerComponent",
      "description": "Logger",
      "level": "INFO",
      "message": "#['Message with body: ' + message.payload() + ', Subject: ' + message.attributes().get('subject')]"
    },
    {
      "implementor": "com.reedelk.runtime.component.ForEach",
      "collection": "#[message.attributes().get('attachments')]",
      "next": [
        {
          "implementor": "com.reedelk.runtime.component.Router",
          "when": [
            {
              "condition": "#[message.payload().key == null]",
              "next": [{
                "implementor": "com.reedelk.core.component.VariableSet",
                "description": "Null Attachment",
                "name": "attachmentFileName",
                "mimeType": "text/plain",
                "value": "#[Util.uuid()]"
              }]
            },
            {
              "condition": "otherwise",
              "next": [{
                "implementor": "com.reedelk.core.component.VariableSet",
                "description": "Attachment name",
                "name": "attachmentFileName",
                "mimeType": "text/plain",
                "value": "#[message.payload().key]"
              }]
            }
          ]
        },
        {
          "implementor": "com.reedelk.core.component.LoggerComponent",
          "description": "Logger",
          "level": "INFO",
          "message": "#['Processing attachment: ' + context.attachmentFileName]"
        },
        {
          "implementor": "com.reedelk.core.component.PayloadSet",
          "description": "Payload Set",
          "mimeType": "application/octet-stream",
          "payload": "#[message.payload().value.content.data]"
        },
        {
          "implementor": "com.reedelk.file.component.FileWrite",
          "description": "File Write",
          "filePath": "#[context.attachmentFileName]",
          "basePath": "/Users/lorenzo/Desktop/attachments",
          "mode": "OVERWRITE",
          "configuration": {"createParentDirectory": true}
        }
      ]
    }
  ]
}